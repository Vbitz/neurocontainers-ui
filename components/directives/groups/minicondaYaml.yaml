metadata:
  key: minicondaYaml
  label: Miniconda Environment
  description: Install Miniconda and create environment from YAML file
  icon: DocumentDuplicate
  color: green
  helpContent: |
    # Miniconda Environment Group

    This group installs Miniconda and creates a conda environment from a YAML specification file.

    ## Options

    - **Environment YAML**: YAML content defining the conda environment specification
    - **Environment Name**: Name for the conda environment (overrides name in YAML)
    - **Install Path**: Directory where Miniconda will be installed
    - **Activate Environment**: Set created environment as default activated environment
    - **Use Mamba**: Use Mamba instead of Conda for faster package resolution
    - **Cleanup**: Remove environment.yml file after creation to reduce image size

    ## Usage

    The Miniconda Environment group will:
    1. Install Miniconda at the specified path
    2. Create an environment.yml file with the provided specification
    3. Create the conda environment using the YAML file
    4. Optionally activate the environment by default
    5. Optionally clean up the YAML file

    ## Environment YAML Format

    The YAML should follow conda environment specification format:
    ```yaml
    name: myenv
    channels:
      - conda-forge
      - defaults
    dependencies:
      - python=3.9
      - numpy
      - pip:
        - some-pip-package
    ```
  keywords:
    - conda
    - miniconda
    - environment
    - yaml
    - packages

arguments:
  - name: environment_yaml
    type: text
    required: true
    defaultValue: |
      name: myenv
      channels:
        - conda-forge
        - defaults
      dependencies:
        - python=3.9
        - numpy
        - scipy
        - matplotlib
        - pip
        - pip:
          - nibabel
          - nilearn
    description: YAML content for the conda environment specification.

  - name: environment_name
    type: text
    required: false
    defaultValue: myenv
    description: Name of the conda environment to create. If not specified, uses name from YAML.

  - name: install_path
    type: text
    required: false
    defaultValue: /opt/miniconda
    description: Path where Miniconda will be installed.

  - name: activate_env
    type: boolean
    required: false
    defaultValue: true
    description: Set the created environment as the default activated environment.

  - name: mamba
    type: boolean
    required: false
    defaultValue: true
    description: Use Mamba instead of Conda for faster package resolution and installation.

  - name: cleanup
    type: boolean
    required: false
    defaultValue: true
    description: Remove the environment.yml file after environment creation to reduce image size.

directives:
  - variables:
      envName: "{{ local.environment_name }}"
      envPath: "{{ local.install_path }}/envs/{{ local.environment_name }}"

  - file:
      name: environment.yml
      contents: "{{ local.environment_yaml }}"

  - template:
      name: miniconda
      version: latest
      install_path: "{{ local.install_path }}"
      mamba: "{{ local.mamba }}"

  - run:
      - 'cp {{ get_file("environment.yml") }} /tmp/environment.yml'
      - "conda config --set channel_priority flexible"
      - "conda env create -f /tmp/environment.yml"

  - run:
      - "rm /tmp/environment.yml"
    condition: local.cleanup

  - environment:
      CONDA_DEFAULT_ENV: "{{ local.envName }}"
      PATH: "{{ local.envPath }}/bin:$PATH"
    condition: local.activate_env

  - run:
      - 'echo "conda activate {{ local.envName }}" >> ~/.bashrc'
    condition: local.activate_env
